# エラー・バグ記録 (errarlog)

## 2026-01-01 22:50: 画像ウィンドウのドラッグ移動が機能しない
### 現象
タイトルバーのない画像ウィンドウ（タイル表示時など）を左ドラッグで移動させようとしても、反応がない、あるいは全てのウィンドウが同じ挙動（最後に開いたウィンドウの操作）になってしまう。

### 原因の分析
1. **クロージャによる変数捕捉のミス**: `TileWindows` などのループ内でイベントハンドラ（`start_drag`, `do_drag`）を定義した際、全てのハンドラがループの最後に代入された `win` 変数を参照してしまっていた。これにより、どのウィンドウをドラッグしても「最後に配置されたウィンドウ」を動かそうとしていた。
2. **座標計算の不安定さ**: `event.x`（ウィンドウ内相対座標）と `winfo_x`（現在のウィンドウ位置）を組み合わせた加算方式は、イベントの発生タイミングや計算誤差により、ウィンドウが震える（ジッタ）原因になりやすく、枠なし移動には不向きであった。

### 対策と修正内容
1. **変数の固定（引数渡し）**: `lambda e, w=win: ...` の形式、または引数に明示的にウィンドウオブジェクトを渡す形式に変更し、各ハンドラが自分のウィンドウを正しく認識するように修正した。
2. **絶対座標方式の導入**: マウスの画面絶対座標（`event.x_root`, `event.y_root`）を使用し、「クリックした瞬間のマウスと窓の距離」を保持して移動させる方式に変更。これにより、非常に滑らかで正確な移動が可能になった。

### 教訓
ループ内でイベントバインドを行う際は、必ず変数をローカルスコープに閉じ込める（`w=win` など）こと。また、枠なしウィンドウの移動には `x_root` 系統の絶対座標を使うのが鉄則である。

## 2026-01-01 23:00: 大量の画像を開くとメモリ消費が累積する（メモリリーク）
### 現象
数多くの画像を閲覧・整列（タイル表示）し続けると、使用メモリが際限なく増大し、動作が重くなる、あるいは動作が不安定になる。

### 原因の分析
1. **リソースの明示的解放不足**: `PIL.Image.open` で開いた画像オブジェクトが正常に閉じられておらず、ガベージコレクション（GC）が走るまでファイルハンドルやメモリが保持され続けていた。
2. **一時オブジェクトの蓄積**: リサイズ後の画像（`img_resized`）や `active_config` での参照が不適切に残っており、メモリを圧迫していた。

### 対策と修正内容
1. **`with` 構文の徹底**: 全ての `Image.open` に `with` 構文を採用し、処理終了と同時に即座にリソースを解放するようにした。
2. **明示的な破棄 (`del`)**: `PhotoImage` に変換した後の不要なイメージオブジェクトに対し、`del` を呼び出してPythonのメモリ管理に早期解放を促すようにした。

### 教訓
PythonのGCを過信せず、特に画像のような重いバイナリデータを扱う際は「使い終わったら即座に棄てる」習慣を徹底することなのじゃ。ポンコツでした。

## 2026-01-02 16:55: GazoToolsLogic.py の SyntaxError
### 現象
`GazoToolsLogic.py` の実行時に `SyntaxError: invalid syntax` が発生した。`except Exception as e:` の行でエラーとなっていた。

### 原因の分析
`edit_tag_dialog` メソッド内で `try` ブロックが記述されておらず、`except` ブロックだけが存在する状態になっていたため、Pythonの構文規則に違反していた。

### 対策と修正内容
`edit_tag_dialog` メソッドの主要な処理を `try` ブロックで囲むように修正した。

### 教訓
コード編集時のブロック対応（try-except, if-elseなど）の確認を怠らないことなのじゃ。

## 2026-01-03 10:10: GazoToolsApp.py の NameError ('config_menu' is not defined)
### 現象
アプリ起動時、またはコード実行時に `NameError: name 'config_menu' is not defined` が発生し、クラッシュした。

### 原因の分析
1. **編集時のコード欠落**: AIスライドショー機能の追加に伴う `GazoToolsApp.py` の大規模改修（`replace_file_content`）を行った際、既存の `menubar` や `config_menu` を初期化・定義するコードブロック（約20行相当）を含めずに別のコードで上書きしてしまった。
2. **定義前の参照**: 定義部分が消滅した状態で、その後の行で `config_menu.add_checkbutton(...)` などとオブジェクトを参照しようとしたため、Pythonインタプリタが「そんな名前の変数は知らない」とエラーを吐いた。

### 対策と修正内容
- **コードの復元**: 消失してしまった `menubar` の作成、ファイルメニューの登録、`config_menu` の作成処理など、UI構築に必要な初期化コードを全て書き戻した。
- **順序の整理**: `ss_mode` などの変数が定義された後、かつメニュー項目追加の前に、確実にメニューオブジェクトの実体が生成されるようにコードの順序を整えた。

### 教訓
大規模なコード置換を行う際は、「置き換え範囲（StartLine〜EndLine）」に含まれる必要なコードまで消してしまっていないか、プレビューやDiffを慎重に確認する必要があるのじゃ。ポンコツでした。

## 2026-01-04 14:30: pytest の validate_ss_interval() テスト失敗
### 現象
`test_config.py` の `TestValidationFunctions::test_validate_ss_interval_invalid` テストが失敗した。

**エラーメッセージ**:
```
AssertionError: assert True is False
 +  where True = validate_ss_interval('5')
```

### 原因の分析
1. **実装と型ヒントのギャップ**: `validate_ss_interval()` 関数の型ヒント（`interval: int`）では整数のみを想定していたが、実装内で `int(interval)` による型変換を行っていた。
2. **文字列の自動変換**: `int("5")` は 5 に変換されるため、バリデーション関数は文字列入力も受け入れてしまい、テストの期待値（False）と異なる結果（True）を返していた。
3. **テスト設計の誤解**: テストは「文字列は無効」と想定していたが、実装は「文字列を数値に変換して検証」という寛容な設計になっていた。

### 対策と修正内容
```python
# テスト修正前
assert validate_ss_interval("5") is False  # ❌ 失敗

# テスト修正後
assert validate_ss_interval(None) is False  # ✅ 成功
```

実装の寛容性に合わせてテストケースを修正。関数が文字列を受け入れる仕様であることを認識した。

### 教訓
型ヒントと実装の動作を統一するか、またはテストで両者のギャップを明示的に検証する必要があるのじゃ。フロントエンドの型チェック追加も検討すべきかな。

## 2026-01-04 14:35: pytest の calculate_folder_window_height() テスト失敗
### 現象
`test_config.py` の `TestWindowSizeCalculation::test_folder_window_height_calculation` テストが失敗した。

**エラーメッセージ**:
```
AssertionError: assert 130 == 120
 +  where 130 = calculate_folder_window_height(2)
```

### 原因の分析
1. **計算ロジックの理解不足**: `calculate_folder_window_height()` は次の計算を行う：
   ```
   calculated = 2 * 20 + 90 = 130
   return max(120, min(800, 130))  # = max(120, 130) = 130
   ```
2. **テストの誤解**: テストは「最小値 120 が適用される」と想定していたが、計算値 130 は既に 120 より大きいため、max() で 130 がそのまま返される。
3. **max() と min() の動作**: `max(120, 130)` = 130 であり、計算値が最小値を超えていると自動的に計算値が採用される。

### 対策と修正内容
```python
# テスト修正前
assert calculate_folder_window_height(2) == 120  # ❌ 期待値が誤り

# テスト修正後
assert calculate_folder_window_height(2) == 130  # ✅ 実装の実動作に合わせた
```

計算ロジックの詳細を確認し、テストの期待値を正しく修正。最小値・最大値は「極端な値」に対する保護であり、中間値は制限を受けないことを理解した。

### 教訓
計算関数のテストは、複数のケース（最小値未満、最大値超過、中間値）を分けて確認し、各段階での動作を明確にすべきなのじゃ。単一のテストケースだけでは仕様の全体像が見えないぞな。

