# GazoTools AI機能の技術解説

## 概要

GazoToolsのAI機能は、画像を「特徴ベクトル」に変換し、ベクトル間の距離を比較することで**類似画像の検出**を実現しています。
画像分類（「これは猫」「これは犬」）ではなく、**画像同士が似ているかどうか**を数値で判定する仕組みです。

---

## 使用モデル: MobileNetV3 Small

### なぜ MobileNetV3 Small なのか

| 項目 | MobileNetV3 Small | ResNet-50 (比較) |
|:---|:---|:---|
| パラメータ数 | 約254万 | 約2,560万 |
| モデルサイズ | 約10 MB | 約98 MB |
| 推論速度 | 高速（モバイル向け設計） | 中速 |
| 精度 | 十分（ImageNet Top-1: 67.7%） | 高い（76.1%） |

MobileNetV3 Smallは**スマートフォン上でリアルタイム動作する**ことを目的に設計された軽量モデルです。
デスクトップアプリでの類似画像検出には十分な精度を持ちながら、CPUのみでも高速に動作します。

### 「Smallなのにサイズが大きい」問題

**モデル自体は約10MBですが、EXE全体は約436MBになります。** その内訳：

```
EXE全体:        約436 MB
├── PyTorch本体:  約320 MB ← ここが大きい
├── Python実行環境: 約50 MB
├── torchvision:  約30 MB
├── その他ライブラリ: 約26 MB
└── モデル重み:    約10 MB  ← モデルはここだけ
```

**大きいのはモデルではなく、PyTorchフレームワーク本体です。**

PyTorchは汎用的な深層学習フレームワークであり、GPU演算ライブラリ（`torch_cpu.dll`だけで約253MB）、
自動微分エンジン、テンソル演算ライブラリなどを全て含んでいます。
MobileNetV3 Smallがどれだけ小さくても、PyTorchを使う限りこのオーバーヘッドは避けられません。

#### サイズを削減する方法（今後の選択肢）

| 方法 | 削減効果 | トレードオフ |
|:---|:---|:---|
| ONNX Runtime に移行 | 320MB → 約30MB | PyTorch依存のコードを書き換える必要がある |
| TorchScript + torch.jit | 若干削減 | 柔軟性が低下する |
| CPU専用ビルドの最適化 | 50-100MB削減 | CUDAサポートを完全に除外する |

---

## 処理の流れ

### 1. 画像の前処理

```
元画像 (任意サイズ)
    ↓ リサイズ (224×224)
    ↓ テンソル変換 (3×224×224 の浮動小数点配列)
    ↓ 正規化 (ImageNet統計量で標準化)
入力テンソル
```

MobileNetV3の学習時と同じ前処理を適用します。
`weights.transforms()` により、モデルに最適化された変換が自動的に適用されます。

### 2. 特徴抽出（推論）

```
入力テンソル (3×224×224)
    ↓ MobileNetV3 の畳み込み層群 (特徴マップ抽出)
    ↓ Global Average Pooling (576次元に圧縮)
    ↓ Linear層 (576 → 1024次元に変換)
    ↓ Hardswish活性化関数
    ↓ Dropout
    ✕ 最終分類層 (1024 → 1000クラス) ← これを削除
出力ベクトル (1024次元)
```

通常のMobileNetV3は最後に1000クラス分類（ImageNetのカテゴリ）を行いますが、
**GazoToolsではこの最終分類層を削除**しています。

```python
# 最後の分類層(Linear 1024→1000)を Identity に置き換え
self.model.classifier = torch.nn.Sequential(
    self.model.classifier[0],  # Linear(576, 1024)
    self.model.classifier[1],  # Hardswish
    self.model.classifier[2],  # Dropout
    torch.nn.Identity()        # 分類しない → 1024次元ベクトルをそのまま出力
)
```

これにより、「猫=0.95, 犬=0.03...」という分類結果ではなく、
**画像の特徴を1024個の数値で表現したベクトル**が得られます。

### 3. L2正規化

```python
norm = feature_vector.norm(p=2)
feature_vector = feature_vector / norm
```

出力ベクトルの大きさを1に正規化します。
これにより、ベクトルの「方向」だけで類似度を比較できるようになります。

### 4. 類似度の計算（コサイン類似度）

```
画像A のベクトル: [0.12, -0.05, 0.33, ...]  (1024次元)
画像B のベクトル: [0.11, -0.04, 0.31, ...]  (1024次元)
    ↓ コサイン類似度を計算
類似度スコア: 0.95 (0.0〜1.0)
```

コサイン類似度は、2つのベクトルが同じ方向を向いているかを測定します。

- **1.0**: 完全に同じ特徴（同一画像）
- **0.8〜0.95**: 非常に似ている（同じ被写体、構図違い等）
- **0.5〜0.8**: やや似ている（同じカテゴリ、色調が近い等）
- **0.0以下**: 全く異なる

---

## ベクトルの解釈（VectorInterpreter）

1024次元のベクトルを人間が理解できるように、5つのカテゴリに分類して表示します。

| カテゴリ | 次元範囲 | 解釈内容 |
|:---|:---|:---|
| 色彩情報 | 0〜250 | 赤色成分、明るさ、彩度など |
| エッジ・線 | 251〜450 | 水平線、垂直線、曲線など |
| テクスチャ | 451〜750 | 滑らか、ざらざら、パターンなど |
| 形状 | 751〜920 | 円形、四角形、対称性など |
| セマンティック | 921〜1023 | 動物、風景、人物などの概念 |

**注意**: この次元→カテゴリのマッピングは概算的なものです。
実際のニューラルネットワークの内部表現は明確に分離されているわけではなく、
複数の特徴が混在して各次元に符号化されています。

---

## パフォーマンス最適化

### 推論時の最適化

```python
self.model.eval()                    # 推論モード（BatchNorm/Dropoutの挙動変更）
torch.set_grad_enabled(False)        # 勾配計算を無効化（メモリ節約・高速化）
with torch.no_grad():                # 推論時に勾配を追跡しない
    output = self.model(input_batch)
```

### バッチ処理

複数画像を一度にモデルに入力することで、1枚ずつ処理するより高速になります。
バッチサイズは8に設定されており、CPU負荷とのバランスを取っています。

### キャッシュ機構

- **メモリキャッシュ（LRU）**: 直近256枚分のベクトルをメモリに保持
- **ファイルキャッシュ（JSON）**: 全てのベクトルを `data/vectors.json` に永続保存
  - キーはファイルのMD5ハッシュ（ファイル名変更に対応）
  - 一度計算した画像は再計算不要

---

## データの永続化

```
data/
├── vectors.json   # 画像ハッシュ → 1024次元ベクトル のマッピング
├── tags.json      # 画像ハッシュ → タグ・評価情報
└── ratings.json   # 評価名 → 評価設定
```

ベクトルデータはファイルのMD5ハッシュをキーとして保存されるため、
ファイルを別フォルダに移動したり名前を変更しても、ベクトルの再計算は不要です。

---

## アーキテクチャ図

```
┌─────────────────────────────────────────────┐
│                GazoToolsApp.py              │
│              (UIレイヤー)                    │
│  ┌──────────┐  ┌──────────┐  ┌───────────┐  │
│  │ メイン    │  │ Visual   │  │ スライド   │  │
│  │ ウィンドウ │  │ Sort     │  │ ショー     │  │
│  └─────┬────┘  └────┬─────┘  └─────┬─────┘  │
└────────┼────────────┼──────────────┼────────┘
         │            │              │
┌────────┼────────────┼──────────────┼────────┐
│        ▼            ▼              ▼        │
│              GazoToolsLogic.py              │
│            (ビジネスロジック)                 │
│                     │                       │
│  ┌─────────────┐    │    ┌────────────────┐ │
│  │ GazoPicture  │    │    │ HakoData       │ │
│  │ (画像制御)    │    │    │ (データ管理)    │ │
│  └──────┬──────┘    │    └───────┬────────┘ │
└─────────┼───────────┼────────────┼──────────┘
          │           │            │
┌─────────┼───────────┼────────────┼──────────┐
│         ▼           ▼            ▼          │
│                  lib/                       │
│  ┌──────────┐  ┌───────────┐  ┌──────────┐ │
│  │GazoTools │  │GazoTools  │  │Vector    │ │
│  │AI.py     │  │Data.py    │  │Interpreter│ │
│  │          │  │           │  │.py       │ │
│  │MobileNet │  │JSON I/O   │  │ベクトル   │ │
│  │V3 Small  │  │           │  │解釈      │ │
│  └──────────┘  └───────────┘  └──────────┘ │
│       │                            │        │
│       ▼                            │        │
│  ┌──────────┐                      │        │
│  │ PyTorch  │◄─────────────────────┘        │
│  │ (320MB)  │  テンソル演算・コサイン類似度    │
│  └──────────┘                               │
└─────────────────────────────────────────────┘
```

---

*作成者: tamate masayuki*
